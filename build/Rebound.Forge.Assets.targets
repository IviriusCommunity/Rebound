<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!-- Import version properties -->
	<Import Project="$(SolutionDir)var\Version.props" />

	<!-- === C++ PROGRAMS === -->
	<!-- ==================== -->

	<!-- 1. Compile Rebound Launcher -->
	<!-- 1. A. Native Launcher Build Targets -->
	<Target Name="BuildNativeHooks" BeforeTargets="BeforeBuild" Condition="'$(Configuration)' == 'Release'">

		<!-- Build Launcher -->
		<Message Importance="high" Text="Compiling Rebound Launcher" />
		<MSBuild Projects="$(SolutionDir)src\system\Rebound.Launcher\Rebound.Launcher.vcxproj" Properties="Configuration=$(Configuration);Platform=$(Platform)" />

		<!-- Copy Launcher -->
		<Message Importance="high" Text="Copying Rebound.Launcher.exe" />
		<Copy SourceFiles="$(SolutionDir)$(Platform)\$(Configuration)\Rebound.Launcher.exe" DestinationFiles="$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\Launchers\Rebound.Launcher.exe" SkipUnchangedFiles="true" />

	</Target>

	<!-- === C# UNPACKAGED APPS === -->
	<!-- ========================== -->

	<!-- 2. Compile Service Host -->
	<!-- 2. A. Define properties for ServiceHost build and zip -->
	<PropertyGroup>
		<ServiceHostBuildOutput>$(SolutionDir)src\system\Rebound.ServiceHost\bin\$(Platform)\$(Configuration)\$(TargetFramework)\$(RuntimeIdentifier)\</ServiceHostBuildOutput>
		<ServiceHostZipDestination>$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\ServiceHost\ServiceHost.zip</ServiceHostZipDestination>
	</PropertyGroup>

	<!-- 2. B. Build and zip ServiceHost -->
	<Target Name="BuildAndZipServiceHost"
			BeforeTargets="BeforeBuild">

		<!-- Build Rebound Service Host -->
		<Message Importance="high" Text="Building Rebound.ServiceHost project in $(Configuration)|$(Platform) with TargetFramework=$(TargetFramework) and RuntimeIdentifier=$(RuntimeIdentifier)" />
		<MSBuild Projects="$(SolutionDir)src\system\Rebound.ServiceHost\Rebound.ServiceHost.csproj"
				 Properties="Configuration=$(Configuration);
                       Platform=$(Platform);
                       TargetFramework=$(TargetFramework);
                       RuntimeIdentifier=$(RuntimeIdentifier)" />

		<!-- Zip the output folder -->
		<Message Importance="high" Text="Zipping ServiceHost output folder '$(ServiceHostBuildOutput)'..." />
		<MakeDir Directories="$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\ServiceHost\" />
		<Exec Command="powershell -NoProfile -Command &quot;Compress-Archive -Path &apos;$(ServiceHostBuildOutput)*&apos; -DestinationPath &apos;$(ServiceHostZipDestination)&apos; -Force&quot;" />
		<Message Importance="high" Text="ServiceHost zipped to $(ServiceHostZipDestination)" />

		<!-- Copy the zip to the Assets project -->
		<Copy SourceFiles="$(ServiceHostZipDestination)"
			  DestinationFolder="$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\ServiceHost\"
			  SkipUnchangedFiles="true" />
		<Message Importance="high" Text="Copied $(ServiceHostZipDestination) to $(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\ServiceHost\" />

	</Target>

	<!-- === PACKAGED APPS === -->
	<!-- ===================== -->

	<!-- #. Generic reusable packaging target -->
	<Target Name="BuildAndCopyMsixPackage">
		<!-- Validate required properties -->
		<Error Condition="'$(PackageProject)' == ''"
			   Text="PackageProject property is required for BuildAndCopyMsixPackage target" />
		<Error Condition="'$(PackageDestination)' == ''"
			   Text="PackageDestination property is required for BuildAndCopyMsixPackage target" />
		<Error Condition="'$(MsixVersion)' == ''"
			   Text="MsixVersion property is required for BuildAndCopyMsixPackage target. Ensure Version.props is imported." />

		<!-- Build the project -->
		<Message Importance="high" Text="Building project $(PackageProject) in $(Configuration)|$(Platform) with AppxBundle=Always" />
		<MSBuild Projects="$(PackageProject)"
				 Targets="Build"
				 Properties="Configuration=$(Configuration);
                       Platform=$(Platform);
                       AppxBundle=Always;
                       UapAppxPackageBuildMode=SideloadOnly;
                       GenerateAppxPackageOnBuild=true">
			<Output TaskParameter="TargetOutputs" ItemName="BuildOutputs" />
		</MSBuild>

		<!-- Get the packaging project's directory and output path -->
		<PropertyGroup>
			<PackageProjectDir>$([System.IO.Path]::GetDirectoryName('$(PackageProject)'))</PackageProjectDir>
			<PackageProjectName>$([System.IO.Path]::GetFileNameWithoutExtension('$(PackageProject)'))</PackageProjectName>
			<!-- Look in the AppPackages folder where MSIX projects output -->
			<ActualPackageOutputFolder>$(PackageProjectDir)\AppPackages\</ActualPackageOutputFolder>
		</PropertyGroup>

		<!-- Find the generated .msixbundle files in the ACTUAL output location -->
		<Message Importance="high" Text="Looking for .msixbundle files in $(ActualPackageOutputFolder)" />

		<ItemGroup>
			<MsixBundles Include="$(ActualPackageOutputFolder)**\*.msixbundle" />
		</ItemGroup>

		<Message Importance="high" Text="Found @(MsixBundles->Count()) msixbundle file(s)" />

		<!-- Error if none found -->
		<Error Condition="'@(MsixBundles)' == ''"
			   Text="No .msixbundle file found in $(ActualPackageOutputFolder). Packaging may have failed." />

		<!-- Filter .msixbundle files by $(MsixVersion) in filename -->
		<ItemGroup>
			<FilteredMsixBundles Include="@(MsixBundles)"
			  Condition="$([System.String]::Copy('%(Filename)').Contains('$(MsixVersion)'))" />
		</ItemGroup>

		<Message Importance="high" Text="After filtering by version '$(MsixVersion)': @(FilteredMsixBundles->Count()) file(s)" />

		<!-- Error if none found after filtering -->
		<Error Condition="'@(FilteredMsixBundles)' == ''"
			   Text="No .msixbundle file found containing '$(MsixVersion)' in $(ActualPackageOutputFolder). Found files: @(MsixBundles)" />

		<!-- Copy to the Forge assets location (where version will be stripped from name) -->
		<Copy SourceFiles="@(FilteredMsixBundles)"
			  DestinationFiles="$(PackageDestination)"
			  SkipUnchangedFiles="true"
			  OverwriteReadOnlyFiles="true" />

		<Message Importance="high"
				 Text="Copied package '@(FilteredMsixBundles)' to $(PackageDestination)" />
	</Target>

	<!-- 3. Compile Rebound About -->
	<!-- 3. A. Define properties for Rebound About build and package copy -->
	<PropertyGroup>
		<ReboundAboutProject>$(SolutionDir)src\apps\Rebound.About\Rebound.About.csproj</ReboundAboutProject>
		<ReboundAboutPackageOutputFolder>$(SolutionDir)src\apps\Rebound.About\AppPackages\</ReboundAboutPackageOutputFolder>
		<ReboundAboutPackageDestination>$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\Packages\Rebound.About.msixbundle</ReboundAboutPackageDestination>
	</PropertyGroup>

	<!-- 3. B. Build and copy Rebound About inside the Assets project -->
	<Target Name="BuildAndCopyReboundAboutPackage"
			BeforeTargets="BeforeBuild"
			Condition="'$(Configuration)' == 'Release'">

		<!-- Call generic packaging with properties - MsixVersion now inherited from imported Version.props -->
		<MSBuild Projects="$(MSBuildProjectFile)"
				 Targets="BuildAndCopyMsixPackage"
				 Properties="PackageProject=$(ReboundAboutProject);
							 PackageDestination=$(ReboundAboutPackageDestination);
							 MsixVersion=$(MsixVersion);
							 Configuration=$(Configuration);
							 Platform=$(Platform)" />

	</Target>

	<!-- 4. Compile Rebound Shell -->
	<!-- 4. A. Define properties for Rebound Shell build and package copy -->
	<PropertyGroup>
		<ReboundShellProject>$(SolutionDir)src\platforms\shell\Rebound.Shell\Rebound.Shell.csproj</ReboundShellProject>
		<ReboundShellPackageOutputFolder>$(SolutionDir)src\platforms\shell\Rebound.Shell\AppPackages\</ReboundShellPackageOutputFolder>
		<ReboundShellPackageDestination>$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\Packages\Rebound.Shell.msixbundle</ReboundShellPackageDestination>
	</PropertyGroup>

	<!-- 4. B. Build and copy Rebound Shell inside the Assets project -->
	<Target Name="BuildAndCopyReboundShellPackage"
			BeforeTargets="BeforeBuild"
			Condition="'$(Configuration)' == 'Release'">

		<!-- Call generic packaging with properties - MsixVersion now inherited from imported Version.props -->
		<MSBuild Projects="$(MSBuildProjectFile)"
				 Targets="BuildAndCopyMsixPackage"
				 Properties="PackageProject=$(ReboundShellProject);
							 PackageDestination=$(ReboundShellPackageDestination);
							 MsixVersion=$(MsixVersion);
							 Configuration=$(Configuration);
							 Platform=$(Platform)" />

	</Target>

	<!-- 5. Compile Rebound User Account Control Settings -->
	<!-- 5. A. Define properties for Rebound User Account Control Settings build and package copy -->
	<PropertyGroup>
		<ReboundUserAccountControlSettingsProject>$(SolutionDir)src\apps\Rebound.UserAccountControlSettings\Rebound.UserAccountControlSettings.csproj</ReboundUserAccountControlSettingsProject>
		<ReboundUserAccountControlSettingsPackageOutputFolder>$(SolutionDir)src\apps\Rebound.UserAccountControlSettings\AppPackages\</ReboundUserAccountControlSettingsPackageOutputFolder>
		<ReboundUserAccountControlSettingsPackageDestination>$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\Packages\Rebound.UserAccountControlSettings.msixbundle</ReboundUserAccountControlSettingsPackageDestination>
	</PropertyGroup>

	<!-- 5. B. Build and copy Rebound User Account Control Settings inside the Assets project -->
	<Target Name="BuildAndCopyReboundUserAccountControlSettingsPackage"
			BeforeTargets="BeforeBuild"
			Condition="'$(Configuration)' == 'Release'">

		<!-- Call generic packaging with properties - MsixVersion now inherited from imported Version.props -->
		<MSBuild Projects="$(MSBuildProjectFile)"
				 Targets="BuildAndCopyMsixPackage"
				 Properties="PackageProject=$(ReboundUserAccountControlSettingsProject);
							 PackageDestination=$(ReboundUserAccountControlSettingsPackageDestination);
							 MsixVersion=$(MsixVersion);
							 Configuration=$(Configuration);
							 Platform=$(Platform)" />

	</Target>

</Project>