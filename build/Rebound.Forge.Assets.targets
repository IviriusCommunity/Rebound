<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	
	<!-- A. Native Launcher Build Targets -->
	<Target Name="BuildNativeHooks" BeforeTargets="BeforeBuild" Condition="'$(Configuration)' == 'Release'">
		<!-- Build Launcher -->
		<Message Importance="high" Text="Compiling Rebound Launcher" />
		<MSBuild Projects="$(SolutionDir)src\system\Rebound.Launcher\Rebound.Launcher.vcxproj" Properties="Configuration=$(Configuration);Platform=$(Platform)" />
		<!-- Copy Launcher -->
		<Message Importance="high" Text="Copying Rebound.Launcher.exe" />
		<Copy SourceFiles="$(SolutionDir)$(Platform)\$(Configuration)\Rebound.Launcher.exe" DestinationFiles="$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\Launchers\Rebound.Launcher.exe" SkipUnchangedFiles="true" />
	</Target>

	<!-- B. Include ServiceHost files as Content items -->
	<PropertyGroup>
		<ServiceHostBuildOutput>$(SolutionDir)src\system\Rebound.ServiceHost\bin\$(Platform)\$(Configuration)\$(TargetFramework)\$(RuntimeIdentifier)\</ServiceHostBuildOutput>
		<ServiceHostZipDestination>$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\ServiceHost\ServiceHost.zip</ServiceHostZipDestination>
	</PropertyGroup>

	<Target Name="BuildAndZipServiceHost"
			BeforeTargets="BeforeBuild">
		<Message Importance="high" Text="Building Rebound.ServiceHost project in $(Configuration)|$(Platform) with TargetFramework=$(TargetFramework) and RuntimeIdentifier=$(RuntimeIdentifier)" />

		<MSBuild Projects="$(SolutionDir)src\system\Rebound.ServiceHost\Rebound.ServiceHost.csproj"
				 Properties="Configuration=$(Configuration);
                       Platform=$(Platform);
                       TargetFramework=$(TargetFramework);
                       RuntimeIdentifier=$(RuntimeIdentifier)" />

		<Message Importance="high" Text="Zipping ServiceHost output folder '$(ServiceHostBuildOutput)'..." />

		<MakeDir Directories="$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\ServiceHost\" />

		<Exec Command="powershell -NoProfile -Command &quot;Compress-Archive -Path &apos;$(ServiceHostBuildOutput)*&apos; -DestinationPath &apos;$(ServiceHostZipDestination)&apos; -Force&quot;" />

		<Message Importance="high" Text="ServiceHost zipped to $(ServiceHostZipDestination)" />

		<Copy SourceFiles="$(ServiceHostZipDestination)"
			  DestinationFolder="$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\ServiceHost\"
			  SkipUnchangedFiles="true" />
	</Target>

	<!-- C. Include Rebound About inside the Assets project -->
	<PropertyGroup>
		<ReboundAboutProject>$(SolutionDir)src\apps\Rebound.About\Rebound.About.csproj</ReboundAboutProject>
		<ReboundAboutPackageSource>$(SolutionDir)src\apps\Rebound.About\AppPackages\Rebound.About\**\*.msixbundle</ReboundAboutPackageSource>
		<ReboundAboutDestination>$(SolutionDir)src\core\forge\Rebound.Forge.Assets\Modding\Packages\Rebound.About.msixbundle</ReboundAboutDestination>
	</PropertyGroup>

<Target Name="BuildAndCopyReboundAboutPackage"
        BeforeTargets="BeforeBuild"
        Condition="'$(Configuration)' == 'Release'">
    <Message Importance="high" Text="Building Rebound.About project..." />
  
    <MSBuild Projects="$(ReboundAboutProject)"
             Properties="Configuration=$(Configuration);
                         Platform=$(Platform);
                         AppxBundle=Always;
                         UapAppxPackageBuildMode=SideloadOnly;
                         GenerateAppxPackageOnBuild=true"
             Targets="Build;_GenerateAppxPackage" />
    
    <Message Importance="high" Text="Looking for .msixbundle files in Rebound.About output..." />
  
    <CreateItem Include="$(SolutionDir)src\apps\Rebound.About\AppPackages\**\*.msixbundle">
        <Output TaskParameter="Include" ItemName="AboutMsixBundles"/>
    </CreateItem>
    
    <Message Importance="high" Text="Found bundles: @(AboutMsixBundles)" />
    
    <Error Condition="'@(AboutMsixBundles)' == ''" 
           Text="No .msixbundle file found. Packaging may have failed." />
    
    <Copy SourceFiles="@(AboutMsixBundles)"
          DestinationFiles="$(ReboundAboutDestination)"
          SkipUnchangedFiles="true" />
    
    <Message Importance="high" Text="Copied Rebound.About package to $(ReboundAboutDestination)" />
</Target>

</Project>