<Page
    x:Class="Rebound.Hub.Views.ModPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:CommunityToolkit.WinUI.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:forge="using:Rebound.Forge"
    xmlns:gallery="using:WinUIGallery.Controls"
    xmlns:local="using:Rebound.Hub.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:media="using:CommunityToolkit.WinUI.Media"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:toolkitControls="using:CommunityToolkit.WinUI.Controls"
    xmlns:ui="using:CommunityToolkit.WinUI"
    mc:Ignorable="d">
    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.ThemeDictionaries>
                <ResourceDictionary x:Key="Light">
                    <SolidColorBrush x:Key="RepairButtonBackgroundBrush" Color="#ba6000" />
                    <SolidColorBrush x:Key="RepairButtonBackgroundPointerOverBrush" Color="#cc7110" />
                    <SolidColorBrush x:Key="RepairButtonBackgroundPressedBrush" Color="#ad5a00" />
                    <ImageSource x:Key="HeroImage">/Assets/Backgrounds/WallpaperLight.png</ImageSource>
                </ResourceDictionary>
                <ResourceDictionary x:Key="Dark">
                    <SolidColorBrush x:Key="RepairButtonBackgroundBrush" Color="#ffa600" />
                    <SolidColorBrush x:Key="RepairButtonBackgroundPointerOverBrush" Color="#ffad42" />
                    <SolidColorBrush x:Key="RepairButtonBackgroundPressedBrush" Color="#de9b45" />
                    <ImageSource x:Key="HeroImage">/Assets/Backgrounds/WallpaperDark.png</ImageSource>
                </ResourceDictionary>
            </ResourceDictionary.ThemeDictionaries>
            <local:ModToTasksListConverter_Page x:Key="ModToTasksListConverter" />
            <local:VariantCountToVisibilityConverter x:Key="VariantCountToVisibilityConverter" />
            <Style x:Key="RepairButtonStyle" TargetType="Button">
                <Setter Property="Foreground" Value="{ThemeResource AccentButtonForeground}" />
                <Setter Property="Background" Value="{ThemeResource RepairButtonBackgroundBrush}" />
                <Setter Property="BackgroundSizing" Value="OuterBorderEdge" />
                <Setter Property="BorderBrush" Value="{ThemeResource AccentButtonBorderBrush}" />
                <Setter Property="CornerRadius" Value="{ThemeResource ControlCornerRadius}" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <ContentPresenter
                                x:Name="ContentPresenter"
                                Padding="{TemplateBinding Padding}"
                                HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                AutomationProperties.AccessibilityView="Raw"
                                Background="{TemplateBinding Background}"
                                BackgroundSizing="{TemplateBinding BackgroundSizing}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Content="{TemplateBinding Content}"
                                ContentTemplate="{TemplateBinding ContentTemplate}"
                                ContentTransitions="{TemplateBinding ContentTransitions}"
                                CornerRadius="{TemplateBinding CornerRadius}"
                                Foreground="{TemplateBinding Foreground}">
                                <ContentPresenter.BackgroundTransition>
                                    <BrushTransition Duration="0:0:0.083" />
                                </ContentPresenter.BackgroundTransition>

                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup x:Name="CommonStates">
                                        <VisualState x:Name="Normal" />

                                        <VisualState x:Name="PointerOver">
                                            <Storyboard>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Background">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource RepairButtonBackgroundPointerOverBrush}" />
                                                </ObjectAnimationUsingKeyFrames>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="BorderBrush">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonBorderBrushPointerOver}" />
                                                </ObjectAnimationUsingKeyFrames>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonForegroundPointerOver}" />
                                                </ObjectAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </VisualState>

                                        <VisualState x:Name="Pressed">
                                            <Storyboard>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Background">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource RepairButtonBackgroundPressedBrush}" />
                                                </ObjectAnimationUsingKeyFrames>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="BorderBrush">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonBorderBrushPressed}" />
                                                </ObjectAnimationUsingKeyFrames>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonForegroundPressed}" />
                                                </ObjectAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </VisualState>

                                        <VisualState x:Name="Disabled">
                                            <Storyboard>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Background">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonBackgroundDisabled}" />
                                                </ObjectAnimationUsingKeyFrames>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="BorderBrush">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonBorderBrushDisabled}" />
                                                </ObjectAnimationUsingKeyFrames>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonForegroundDisabled}" />
                                                </ObjectAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </ContentPresenter>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
            <converters:CollectionVisibilityConverter x:Key="CollectionVisibilityConverter" />
            <converters:BoolToObjectConverter
                x:Key="BoolToReverseVisibilityConverter"
                FalseValue="Visible"
                TrueValue="Collapsed" />
            <converters:BoolToObjectConverter
                x:Key="BoolNegationConverter"
                FalseValue="True"
                TrueValue="False" />
            <converters:DoubleToVisibilityConverter
                x:Key="ModTypeToVisibilityConverter_Bool"
                GreaterThan="-1"
                LessThan="1" />
            <converters:DoubleToVisibilityConverter
                x:Key="ModTypeToVisibilityConverter_String"
                GreaterThan="0"
                LessThan="2" />
            <converters:EmptyStringToObjectConverter
                x:Key="EmptyStringToObjectConverter"
                EmptyValue="False"
                NotEmptyValue="True" />
            <local:GlyphToIconSourceConverter x:Key="GlyphToIconSourceConverter" />
            <DataTemplate x:Key="BoolSettingTemplate" x:DataType="forge:ModBoolSetting">
                <toolkitControls:SettingsCard
                    Description="{x:Bind Description}"
                    Header="{x:Bind Name}"
                    HeaderIcon="{x:Bind IconGlyph, Converter={StaticResource GlyphToIconSourceConverter}}">
                    <ToggleSwitch IsOn="{x:Bind Value, Mode=TwoWay}" />
                </toolkitControls:SettingsCard>
            </DataTemplate>

            <DataTemplate x:Key="StringSettingTemplate" x:DataType="forge:ModStringSetting">
                <toolkitControls:SettingsCard
                    Description="{x:Bind Description}"
                    Header="{x:Bind Name}"
                    HeaderIcon="{x:Bind IconGlyph, Converter={StaticResource GlyphToIconSourceConverter}}">
                    <TextBox PlaceholderText="{x:Bind PlaceholderText}" Text="{x:Bind Value, Mode=TwoWay}" />
                </toolkitControls:SettingsCard>
            </DataTemplate>

            <DataTemplate x:Key="EnumSettingTemplate" x:DataType="forge:ModEnumSetting">
                <toolkitControls:SettingsCard
                    Description="{x:Bind Description}"
                    Header="{x:Bind Name}"
                    HeaderIcon="{x:Bind IconGlyph, Converter={StaticResource GlyphToIconSourceConverter}}">
                    <ComboBox ItemsSource="{x:Bind Options}" SelectedIndex="{x:Bind Value, Mode=TwoWay}" />
                </toolkitControls:SettingsCard>
            </DataTemplate>

            <DataTemplate x:Key="InfoBarTemplate" x:DataType="forge:ModInfoBar">
                <muxc:InfoBar
                    Title="{x:Bind Title}"
                    IsClosable="{x:Bind IsClosable}"
                    IsOpen="True"
                    Message="{x:Bind Message}"
                    Severity="{x:Bind Severity, Converter={StaticResource ModSeverityConverter}}" />
            </DataTemplate>

            <DataTemplate x:Key="LabelTemplate" x:DataType="forge:ModLabel">
                <TextBlock
                    Margin="0,32,0,8"
                    Style="{StaticResource BodyStrongTextBlockStyle}"
                    Text="{x:Bind Text}" />
            </DataTemplate>

            <local:ModSeverityToInfoBarSeverityConverter x:Key="ModSeverityConverter" />

            <!--  The selector  -->
            <local:ModSettingTemplateSelector
                x:Key="ModSettingSelector"
                BoolSettingTemplate="{StaticResource BoolSettingTemplate}"
                EnumSettingTemplate="{StaticResource EnumSettingTemplate}"
                InfoBarTemplate="{StaticResource InfoBarTemplate}"
                LabelTemplate="{StaticResource LabelTemplate}"
                StringSettingTemplate="{StaticResource StringSettingTemplate}" />
        </ResourceDictionary>
    </Page.Resources>
    <ScrollViewer HorizontalAlignment="Stretch">
        <ContentControl HorizontalContentAlignment="Stretch" Content="{x:Bind Mod}">
            <ContentControl.ContentTemplate>
                <DataTemplate x:DataType="forge:Mod">
                    <Grid>
                        <!--  Header image  -->
                        <gallery:HomePageHeaderImage
                            x:Name="BKGImage"
                            Height="320"
                            MaxWidth="800"
                            VerticalAlignment="Top"
                            Image="{x:Bind Icon}"
                            Opacity="0.15" />

                        <!--  Blur  -->
                        <Grid Height="600" VerticalAlignment="Top">
                            <Grid.Background>
                                <media:BackdropBlurBrush Amount="64.0" />
                            </Grid.Background>
                        </Grid>

                        <Grid
                            MaxWidth="1000"
                            Margin="32"
                            ColumnSpacing="16"
                            RowSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <Image
                                Grid.RowSpan="3"
                                Width="80"
                                Height="80"
                                VerticalAlignment="Top"
                                Source="{x:Bind Icon}" />
                            <TextBlock
                                Grid.Column="1"
                                Margin="0,12,0,0"
                                FontSize="20"
                                FontWeight="SemiBold"
                                Text="{x:Bind Name}"
                                TextWrapping="WrapWholeWords" />
                            <TextBlock
                                Grid.Row="1"
                                Grid.Column="1"
                                Text="{x:Bind Description}"
                                TextWrapping="WrapWholeWords" />

                            <!--  Variant Selector (only visible if more than 1 variant)  -->
                            <toolkitControls:SettingsCard
                                Grid.Row="2"
                                Grid.ColumnSpan="3"
                                Margin="0,8,0,0"
                                HorizontalAlignment="Stretch"
                                Description="Pick what variant of this mod you want to install."
                                Header="Variant"
                                Visibility="{x:Bind Variants.Count, Mode=OneWay, Converter={StaticResource VariantCountToVisibilityConverter}}">
                                <toolkitControls:SettingsCard.HeaderIcon>
                                    <FontIcon Glyph="&#xE713;" />
                                </toolkitControls:SettingsCard.HeaderIcon>
                                <ComboBox ItemsSource="{x:Bind Variants, Mode=OneWay}" SelectedIndex="{x:Bind SelectedVariantIndex, Mode=TwoWay}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate x:DataType="forge:ModVariant">
                                            <TextBlock Text="{x:Bind Name, Mode=OneWay}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </toolkitControls:SettingsCard>

                            <!--  Buttons area  -->
                            <Grid
                                Grid.RowSpan="3"
                                Grid.Column="2"
                                Margin="0,16,0,0"
                                VerticalAlignment="Top"
                                ColumnSpacing="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <!--  Action flyout (Install/Uninstall/Repair/Open)  -->
                                <Button
                                    Grid.Column="1"
                                    Padding="8"
                                    Background="Transparent"
                                    BorderBrush="Transparent">
                                    <FontIcon FontSize="16" Glyph="&#xE712;" />
                                    <Button.Flyout>
                                        <MenuFlyout>
                                            <!--  Install  -->
                                            <MenuFlyoutItem
                                                Command="{x:Bind InstallCommand}"
                                                IsEnabled="{x:Bind IsInstalled, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}"
                                                Text="Install">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE896;" />
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>

                                            <!--  Uninstall  -->
                                            <MenuFlyoutItem
                                                Command="{x:Bind UninstallCommand}"
                                                IsEnabled="{x:Bind IsInstalled, Mode=OneWay}"
                                                Text="Uninstall">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE74D;" />
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>

                                            <!--  Repair  -->
                                            <MenuFlyoutItem
                                                Command="{x:Bind RepairCommand}"
                                                IsEnabled="{x:Bind IsIntact, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}"
                                                Text="Repair">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE90F;" />
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>

                                            <!--  Open  -->
                                            <MenuFlyoutItem
                                                Command="{x:Bind OpenCommand}"
                                                IsEnabled="{x:Bind IsInstalled, Mode=OneWay}"
                                                Text="Open">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE8A7;" />
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                        </MenuFlyout>
                                    </Button.Flyout>
                                </Button>

                                <!--  Corruption indicator  -->
                                <Grid
                                    Grid.Column="2"
                                    Padding="8"
                                    HorizontalAlignment="Left"
                                    Background="Transparent"
                                    ToolTipService.ToolTip="This mod is corrupted and needs to be repaired."
                                    Visibility="{x:Bind IsIntact, Mode=OneWay, Converter={StaticResource BoolToReverseVisibilityConverter}}">
                                    <FontIcon
                                        FontSize="16"
                                        Foreground="{ThemeResource RepairButtonBackgroundBrush}"
                                        Glyph="&#xF736;" />
                                </Grid>

                                <!--  Open/Install/Repair buttons  -->
                                <Grid Grid.Column="3" Visibility="{x:Bind IsIntact, Mode=OneWay}">
                                    <!--  Open button (visible if installed)  -->
                                    <Button
                                        HorizontalAlignment="Stretch"
                                        Command="{x:Bind OpenCommand}"
                                        Content="Open"
                                        Visibility="{x:Bind IsInstalled, Mode=OneWay}" />

                                    <!--  Install button (visible if not installed)  -->
                                    <Button
                                        HorizontalAlignment="Stretch"
                                        Command="{x:Bind InstallCommand}"
                                        Content="Install"
                                        Style="{StaticResource AccentButtonStyle}"
                                        Visibility="{x:Bind IsInstalled, Mode=OneWay, Converter={StaticResource BoolToReverseVisibilityConverter}}" />
                                </Grid>

                                <!--  Repair button (visible if mod is corrupted)  -->
                                <Button
                                    Grid.Column="3"
                                    HorizontalAlignment="Stretch"
                                    Command="{x:Bind RepairCommand}"
                                    Content="Repair"
                                    Style="{StaticResource RepairButtonStyle}"
                                    Visibility="{x:Bind IsIntact, Mode=OneWay, Converter={StaticResource BoolToReverseVisibilityConverter}}" />
                            </Grid>
                            <StackPanel
                                Grid.Row="4"
                                Grid.ColumnSpan="3"
                                Margin="0,8,0,0">
                                <muxc:InfoBar
                                    Title="This mod does the following:"
                                    HorizontalAlignment="Stretch"
                                    IsClosable="False"
                                    IsOpen="True">
                                    <ContentPresenter Content="{x:Bind Converter={StaticResource ModToTasksListConverter}}" />
                                </muxc:InfoBar>
                                <muxc:ProgressRing Tag="ItemsControlRing" HorizontalAlignment="Center" Width="32" Height="32" Margin="0, 32, 0, 0"/>
                                <ItemsControl
                                    Margin="0,16,0,0"
                                    ItemTemplateSelector="{StaticResource ModSettingSelector}"
                                    Tag="{x:Bind}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Vertical" Spacing="4" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </DataTemplate>
            </ContentControl.ContentTemplate>
        </ContentControl>
    </ScrollViewer>
</Page>