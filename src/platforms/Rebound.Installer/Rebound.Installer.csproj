<Project Sdk="Microsoft.NET.Sdk">

	<!-- Properties -->
	<PropertyGroup>

		<!-- General -->
		<OutputType>WinExe</OutputType>
		<AssemblyName>Rebound Hub Installer</AssemblyName>
		<ApplicationIcon>Assets\ReboundHubInstaller.ico</ApplicationIcon>
		<ApplicationManifest>app.manifest</ApplicationManifest>

		<!-- Deployment -->
		<EnableMsixTooling>true</EnableMsixTooling>
		<WindowsPackageType>None</WindowsPackageType>

		<!-- Self-contained settings -->
		<SelfContained>true</SelfContained>
		<PublishSingleFile>true</PublishSingleFile>
		<WindowsAppSDKSelfContained>true</WindowsAppSDKSelfContained>
		<IncludeNativeLibrariesForSelfExtract>true</IncludeNativeLibrariesForSelfExtract>
		<CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
		<PublishAot>false</PublishAot>
		<IncludeWinAppSDKNativeDlls>false</IncludeWinAppSDKNativeDlls>
		<IncludeWinAppSDKMsixContent>false</IncludeWinAppSDKMsixContent>

		<!-- Trimmming -->
		<PublishTrimmed>false</PublishTrimmed>

	</PropertyGroup>

	<!-- Project content -->
	<ItemGroup>
		<None Remove="Assets\ReboundHubInstaller.ico" />
		<None Remove="Certificate.cer" />
		<None Remove="dotNET9Runtime.exe" />
		<None Remove="Package.msix" />
		<Content Include="Certificate.cer" />
		<Content Include="dotNET9Runtime.exe" />
		<Content Include="Package.msix" />
	</ItemGroup>

	<!-- Project references -->
	<ItemGroup>
		<ProjectReference Include="..\..\core\unpackaged\Rebound.Core.SourceGeneratorAttributes\Rebound.Core.SourceGeneratorAttributes.csproj" />
		<ProjectReference Include="..\..\core\unpackaged\Rebound.Core.SourceGenerator\Rebound.Core.SourceGenerator.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
	</ItemGroup>

	<!-- Shared project imports -->
	<Import Project="..\..\core\forge\Rebound.Forge\Rebound.Forge.projitems" Label="Shared" />
	<Import Project="..\..\core\shared\Rebound.Core.Helpers\Rebound.Core.Helpers.projitems" Label="Shared" />

	<!-- Publish Rebound -->
	<Target Name="PackageReboundApp" BeforeTargets="Build" Condition="'$(Configuration)' == 'Release'">
		<!-- Read .csproj and extract Version using regex -->
		<ReadLinesFromFile File="..\Rebound.App\Rebound.App.csproj">
			<Output TaskParameter="Lines" ItemName="CsprojLines" />
		</ReadLinesFromFile>

		<ItemGroup>
			<VersionLine Include="@(CsprojLines)" Condition="$([System.Text.RegularExpressions.Regex]::IsMatch('%(Identity)', '&lt;Version&gt;(.*)&lt;/Version&gt;'))" />
		</ItemGroup>

		<PropertyGroup>
			<!-- Extract the version string using regex -->
			<AppVersion>$([System.Text.RegularExpressions.Regex]::Match('%(VersionLine.Identity)', '<Version>(.*)</Version>').Groups[1].Value)</AppVersion>
			
			<SourceMsixPath>..\Rebound.App\bin\x64\Release\net9.0-windows10.0.26100.0\AppPackages\Rebound.App_$(AppVersion).0_x64_Test\Rebound.App_$(AppVersion).0_x64.msix</SourceMsixPath>
			<SourceCertPath>..\Rebound.App\bin\x64\Release\net9.0-windows10.0.26100.0\AppPackages\Rebound.App_$(AppVersion).0_x64_Test\Rebound.App_$(AppVersion).0_x64.cer</SourceCertPath>
			
			<DestinationMsixPath>$(MSBuildThisFileDirectory)Package.msix</DestinationMsixPath>
			<DestinationCertPath>$(MSBuildThisFileDirectory)Certificate.cer</DestinationCertPath>
		</PropertyGroup>

		<Message Importance="high" Text="Packing MSIX version $(AppVersion)" />

		<!-- Publish Rebound.App -->
		<!--<MSBuild Projects="..\Rebound.App\Rebound.App.csproj"
				 Targets="Publish"
				 Properties="Configuration=Release;Platform=x64" />-->

		<Copy SourceFiles="$(SourceMsixPath)" DestinationFiles="$(DestinationMsixPath)" OverwriteReadOnlyFiles="true" />
		<Copy SourceFiles="$(SourceCertPath)" DestinationFiles="$(DestinationCertPath)" OverwriteReadOnlyFiles="true" />
	</Target>

</Project>